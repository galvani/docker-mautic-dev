version: "3.2"

services:
  mysql:
    env_file:
      - ".env"
    image: 'mysql/mysql-server:8.0'
    ports:
      - '${MYSQL_PUBLIC_PORT}:3306'
    expose:
      - 3306
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
  redis:
    restart: always
    image: 'redis:latest'
    expose:
      - 6379
  redis-commander:
    env_file:
      - ".env"
    environment:
      - REDIS_HOST=redis
    image: rediscommander/redis-commander
    ports:
      - "${REDIS_COMMANDER_PORT}:8081"
  mailhog:
    image: mailhog/mailhog
    ports:
      - "${MAILOG_UI_PORT}:8025"
    expose:
      - 1025
  nginx:
    env_file:
      - ".env"
    image: nginx
    restart: "no"
    ports:
      - "${MAUTIC_PUBLIC_PORT}:80"
    environment:
      - PHP_FPM=php:9000
      - NGINX_HOST=mautic.local
      - NGINX_PORT=80
    depends_on:
      - php
    links:
      - php
    volumes:
      - ./.docker/nginx/templates:/etc/nginx/templates
      - ./mautic:/var/www/html
      - ./var/log/nginx:/var/log/nginx
  php:
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: "no"
    build: .docker/php8.1
    volumes:
      - "userroot:/root"
      - ./mautic:/var/www/html
    environment:
      XDEBUG_ENABLED: 1
      XDEBUG_REMOTE_AUTOSTART: 1
      XDEBUG_MAXNESTING_LEVEL: 1000
      XDEBUG_REMOTE_CONNECT_BACK: 1
      XDEBUG_REMOTE_HOST: host.docker.internal
      XDEBUG_CLIENT_PORT: 9008
      DDEV_TLD: 1
      MESSENGER_TRANSPORT_DSN: amqp://admin:admin@rabbitmq:5672/0
      MAUTIC_MESSENGER_TRANSPORT_DSN: amqp://admin:admin@rabbitmq:5672/0
      APP_ENV: dev
    command: >
      sh -c "chmod -R 777 /var/www/html/var &&
        chmod -R 777 /var/www/html/media &&
        chmod -R 777 /var/www/html/app/config &&
        php-fpm -F -R"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    expose:
      - 9000
  rabbitmq:
      image: rabbitmq:3.11-management
      environment:
        - RABBITMQ_DEFAULT_USER=admin
        - RABBITMQ_DEFAULT_PASS=admin
      ports:
        - "${RABBITMQ_MANAGEMENT_PORT}:15672"
      expose:
        - 5672
      volumes:
        - "./.docker/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins"

volumes:
  userroot:
